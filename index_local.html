<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>碳报告生成器 - 本地版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 40px; }
        .container { max-width: 600px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="file"] { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background-color: #aaa; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>碳盘查报告生成器 - 本地版</h2>
        <p><em>注意：这是本地版本，只能读取和显示数据，无法生成Word报告或AI摘要。</em></p>

        <div class="form-group">
            <label for="excel_file">Excel 文件:</label>
            <input type="file" id="excel_file" name="excel_file" accept=".xlsx, .xls">
        </div>

        <div class="form-group">
            <label for="company_name">公司名称:</label>
            <input type="text" id="company_name" name="company_name" value="大冶特殊钢">
        </div>

        <div class="form-group">
            <label for="report_year">报告年份:</label>
            <input type="text" id="report_year" name="report_year" value="2024">
        </div>

        <button id="analyze_btn">分析数据</button>

        <div id="status"></div>
        <div id="result" style="margin-top: 20px; display: none;">
            <h3>数据分析结果：</h3>
            <pre id="data_display" style="background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;"></pre>
        </div>
    </div>

    <script>
        const btn = document.getElementById('analyze_btn');
        const status = document.getElementById('status');
        const result = document.getElementById('result');
        const dataDisplay = document.getElementById('data_display');

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function extractDataFromExcel(data) {
            if (!data || data.length < 2) return null;

            // 尝试提取数据（简化版本）
            const result = {
                company_name: document.getElementById('company_name').value,
                report_year: document.getElementById('report_year').value,
                raw_data: data
            };

            // 查找公司名称和年份
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (row && row.length > 1) {
                    if (typeof row[0] === 'string' && row[0].includes('公司')) {
                        result.company_name = row[1] || result.company_name;
                    }
                    if (typeof row[0] === 'string' && row[0].includes('年份')) {
                        result.report_year = row[1] || result.report_year;
                    }
                }
            }

            return result;
        }

        btn.addEventListener('click', async () => {
            const fileInput = document.getElementById('excel_file');

            if (fileInput.files.length === 0) {
                status.innerHTML = '<div class="error">错误：请先选择一个 Excel 文件。</div>';
                return;
            }

            status.textContent = "正在分析Excel文件，请稍候...";
            btn.disabled = true;
            result.style.display = 'none';

            try {
                const file = fileInput.files[0];
                const excelData = await readExcelFile(file);
                const extractedData = extractDataFromExcel(excelData);

                if (extractedData) {
                    status.innerHTML = '<div class="success">Excel文件分析成功！</div>';

                    // 显示提取的数据
                    let displayText = `公司名称: ${extractedData.company_name}\n`;
                    displayText += `报告年份: ${extractedData.report_year}\n\n`;
                    displayText += `Excel数据预览（前10行）:\n`;

                    for (let i = 0; i < Math.min(10, extractedData.raw_data.length); i++) {
                        const row = extractedData.raw_data[i];
                        if (row && row.length > 0) {
                            displayText += `第${i+1}行: ${row.join(' | ')}\n`;
                        }
                    }

                    dataDisplay.textContent = displayText;
                    result.style.display = 'block';
                } else {
                    status.innerHTML = '<div class="error">无法从Excel文件中提取数据，请检查文件格式。</div>';
                }

            } catch (error) {
                console.error('Error:', error);
                status.innerHTML = `<div class="error">处理文件时发生错误: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>